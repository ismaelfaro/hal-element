<!--
Copyright (c) 2014 Polymer-spain - Ismael Faro. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
-->

<link rel="import" href="../polymer/polymer.html">

<script src="js/deixibot.js"></script>
<script src="js/aliziadata.js"></script>
<script src="js/deixilog.js"></script>

<!--
@group Polymer Education Elements

`edu-terminal` is a web component that show the flexibility of Polymer and webcomponents to create the next Web generation Apps. This
component allows you understand the use of webcomponents. You can extend this class to create new types of terminal emulators.

Example to create Terminal component:

    <edu-brain id="brain"><edu-brain>
    
    <script>
        var animation = document.getElementById('brain');
        
    </script>

@element edu-terminal
@status beta
@homepage github.io


  <form id="chatForm" onsubmit="">
        </form>

-->

<polymer-element name="edu-brain" attributes="memory language say listen terminalInput terminalOutput face">
    <template>
<!--        <core-ajax id="topodata" auto url="memory/{{memory}}.{{language}}.json" handleAs="json" response="{{loadKnowledge}}"></core-ajax>-->
   
     <img id="chatCam" src="img/{{face}}.jpg" alt="{{face}}">

    </template>
    <script>
        Polymer({
            language: 'es-ES',
            knowledge: null,
            say: '',
            listen: '',
            brain: null,
            name: '',
            chatLines: null,
            sessionId: 0,
            userLabel: "TÃš",
            speech: null,
            slide: 1,
            speechUserInput: '',
            presentation: document.getElementById('slides'),
            face: 'hal9000',

            ready: function () {
                console.log('edu-brain init');
                // Setup //
                this.chatLines = new Array();
                this.speech = new SpeechSynthesisUtterance();
                this.speech.lang = 'es-ES';

                this.brain = new DeixiBot(botData);
                this.name = "HAL";

                this.reset();
            },
            loadKnowledgeChanged: function () {
                knowledge = this.response;
            },
            thinkAbout: function () {

            },
            brainActivity: function () {
                console.log('----brain---');


            },
            talk: function (texto) {

                if (!texto) return;

                console.log(texto);

                this.speech.text = texto;

                window.speechSynthesis.speak(this.speech);
                document.forms.chatForm.chatInput.focus();

            },
            chat: function () {
                console.info('chat');
                var form = document.forms.chatForm;
                var userInput = form.chatInput.value;
                var control = null;
                                
                if (this.speechUserInput === '') {
                    command = userInput;
                } else {
                    command = speechUserInput;
                }
                console.log(command);
                if (command === "siguiente") {
                    this.slide += 1;
                    console.log('+1')
                    control = true;
                    userInput = '';
                }
                if (command === "anterior") {
                    this.slide -= 1;
                    control = true;
                    userInput = '';
                }

                if (userInput != '') {
                    var userLine = userLabel + ":" + "          ".slice(-(7 - userLabel.length)) + userInput;
                    var contesta = this.brain.transform(userInput);

                    var botLine = botName + ":" + "          ".slice(-(7 - botName.length)) + contesta;

                    form.chatInput.value = '';
                    this.chatLines.push(userLine);
                    this.displayLines();
                    this.chatLines.push(botLine);

                    //logText(sessionId,userLine + "||" + botLine);
                    window.setTimeout(this.displayLines, 100);


                } else if (this.chatLines.length == 0) {
                    for (var i = 0; i < 20; i++) {
                        this.chatLines.push(" ");
                    };
                    var contesta = this.brain.getInitial()
                    var botLine = this.name + ":" + "          ".slice(-(7 - this.name.length)) + contesta;
                    this.chatLines.push(botLine);
                    this.displayLines();
                }

                if (control == true) {
                    control = false;
                }

                this.talk(contesta);

            },
            reset: function () {
                //sessionId = generateSessionId();
                console.info('reset');
                this.brain.reset();
                this.chatLines.length = 0;
                document.forms.chatForm.chatInput.value = '';
                document.forms.chatForm.chatInput.focus();
                this.chat();
            },
            displayLines: function() {
                var chatText = document.getElementById('chatText');
                chatText.value = this.chatLines.join('\n');
                chatText.scrollTop = chatText.scrollHeight;
            }
        });
    </script>
</polymer-element>